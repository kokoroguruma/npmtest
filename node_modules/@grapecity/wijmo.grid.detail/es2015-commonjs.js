/*!
    *
    * Wijmo Library 5.20201.680
    * http://wijmo.com/
    *
    * Copyright(c) GrapeCity, Inc.  All rights reserved.
    *
    * Licensed under the GrapeCity Commercial License.
    * sales@wijmo.com
    * wijmo.com/products/wijmo-5/license/
    *
    */

"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const wijmo_1=require("@grapecity/wijmo"),wijmo_grid_1=require("@grapecity/wijmo.grid"),selfModule=require("@grapecity/wijmo.grid.detail");class DetailRow extends wijmo_grid_1.Row{constructor(e){super();this.isReadOnly=!0}get detail(){return this._detail}set detail(e){this._detail=e}}exports.DetailRow=DetailRow;class DetailMergeManager extends wijmo_grid_1.MergeManager{constructor(e){super(e)}getMergedRange(e,i,t,l=!0){switch(e.cellType){case wijmo_grid_1.CellType.Cell:if(e.rows[i]instanceof DetailRow){let t=e.columns;t.frozen>0&&e.grid&&(e.grid.cloneFrozenCells=!1);return new wijmo_grid_1.CellRange(i,0,i,t.length-1)}break;case wijmo_grid_1.CellType.RowHeader:let l=e.rows.frozen;if(e.rows[i]instanceof DetailRow&&i!=l)return new wijmo_grid_1.CellRange(i-1,t,i,t);if(i<e.rows.length-1&&e.rows[i+1]instanceof DetailRow&&i!=l-1)return new wijmo_grid_1.CellRange(i,t,i+1,t)}return super.getMergedRange(e,i,t,l)}}exports.DetailMergeManager=DetailMergeManager;wijmo_1._addCultureInfo("FlexGridDetailProvider",{ariaLabels:{toggleDetail:"Toggle Row Detail"}});var KeyAction,DetailVisibilityMode;!function(e){e[e.None=0]="None";e[e.ToggleDetail=1]="ToggleDetail"}(KeyAction=exports.KeyAction||(exports.KeyAction={}));!function(e){e[e.Code=0]="Code";e[e.Selection=1]="Selection";e[e.ExpandSingle=2]="ExpandSingle";e[e.ExpandMulti=3]="ExpandMulti"}(DetailVisibilityMode=exports.DetailVisibilityMode||(exports.DetailVisibilityMode={}));class FlexGridDetailProvider{constructor(e,i){this._mode=DetailVisibilityMode.ExpandSingle;this._animated=!1;this._keyActionEnter=KeyAction.None;this._g=e;e.mergeManager=new DetailMergeManager(e);e.rowHeaders.hostElement.addEventListener("click",this._hdrClick.bind(this));e.rowHeaders.hostElement.addEventListener("mousedown",i=>{let t=e.editableCollectionView;if(e.activeEditor||t&&t.currentEditItem){this._hdrClick(i);i.preventDefault()}});e.formatItem.addHandler(this._formatItem,this);e.selectionChanged.addHandler(this._selectionChanged,this);e.resizedRow.addHandler(this._resizedRow,this);e.loadingRows.addHandler(()=>this.hideDetail());e.deletingRow.addHandler((e,i)=>{this.hideDetail(i.row)});e.updatedView.addHandler(this._handleFrozenCells,this);e.draggingRow.addHandler((e,i)=>{if(i.row<e.rows.length-1&&e.rows[i.row+1]instanceof DetailRow){i.cancel=!0;this.hideDetail(i.row)}});e.hostElement.addEventListener("keydown",e=>{if(e.keyCode==wijmo_1.Key.Enter&&this._keyActionEnter==KeyAction.ToggleDetail){let i=this._g.selection.row;this._toggleRowDetail(i)&&e.preventDefault()}},!0);e._root.addEventListener("scroll",()=>{wijmo_1.Control.refreshAll(e._root)});i&&wijmo_1.copy(this,i)}get grid(){return this._g}get detailVisibilityMode(){return this._mode}set detailVisibilityMode(e){if((e=wijmo_1.asEnum(e,DetailVisibilityMode))!=this._mode){this._mode=e;this.hideDetail();this._g.invalidate()}}get maxHeight(){return this._maxHeight}set maxHeight(e){if((e=wijmo_1.asNumber(e,!0))!=this._maxHeight){this._maxHeight=e;this.hideDetail()}}get isAnimated(){return this._animated}set isAnimated(e){e!=this._animated&&(this._animated=wijmo_1.asBoolean(e))}get keyActionEnter(){return this._keyActionEnter}set keyActionEnter(e){this._keyActionEnter=wijmo_1.asEnum(e,KeyAction)}get createDetailCell(){return this._createDetailCellFn}set createDetailCell(e){this._createDetailCellFn=wijmo_1.asFunction(e,!0)}get disposeDetailCell(){return this._disposeDetailCellFn}set disposeDetailCell(e){this._disposeDetailCellFn=wijmo_1.asFunction(e,!0)}get rowHasDetail(){return this._rowHasDetailFn}set rowHasDetail(e){if((e=wijmo_1.asFunction(e,!0))!=this._rowHasDetailFn){this._rowHasDetailFn=e;this.hideDetail();this._g.invalidate()}}getDetailRow(e){let i=this._g.rows,t=this._toIndex(e),l=i[t];!(l instanceof DetailRow)&&t<i.length-1&&(l=i[t+1]);return l instanceof DetailRow?l:null}isDetailVisible(e){return null!=this.getDetailRow(e)}isDetailAvailable(e){e=this._toIndex(e);return this._hasDetail(e)}hideDetail(e){let i=this._g.rows;if(null==e){for(let e=0;e<i.length;e++)i[e]instanceof DetailRow&&this.hideDetail(e);return}!(i[e=this._toIndex(e)]instanceof DetailRow)&&e<i.length-1&&i[e+1]instanceof DetailRow&&e++;let t=i[e];if(t instanceof DetailRow){let l=!1;this.disposeDetailCell&&(l=this.disposeDetailCell(t));l||wijmo_1.Control.disposeAll(t.detail);i.removeAt(e)}}showDetail(e,i=!1){let t=this._g,l=t.rows;(e=this._toIndex(e))>0&&l[e]instanceof DetailRow&&e--;if(i){let i=t.selection,o=!1;for(let t=0;t<l.length-1;t++)if(t!=e&&l[t+1]instanceof DetailRow){this.hideDetail(t);t<e&&e--;if(t<i.row){i.row--;i.row2--;o=!0}}o&&t.select(i,!1)}if(!this.isDetailVisible(e)&&this._hasDetail(e)){let i=new DetailRow(l[e]),o=this._createDetailCell(l[e]);i.detail=o;if(o){l.insert(e+1,i);let a=t.containsFocus();if(this._animated){let i=o.style;i.transform="translateY(-100%)";i.opacity="0";wijmo_1.animate(l=>{if(l<1){i.transform="translateY("+(100*-(1-l)).toFixed(0)+"%)";i.opacity=(l*l).toString()}else{i.transform=i.opacity="";wijmo_1.Control.invalidateAll(o);a&&t.scrollIntoView(e+1,-1)}})}else a&&t.scrollIntoView(e+1,-1,!0)}}}_sizeDetailRow(e){let i=this._g,t=e.detail;wijmo_1.Control.refreshAll(t);let l=t.offsetHeight+i._cellPadVert+1,o=this._maxHeight;wijmo_1.isNumber(o)&&o>0&&l>o&&(l=o);e.height=l;t.style.height||(t.style.height="100%");let a=t.querySelector(".wj-flexgrid");a&&!a.style.height&&(a.style.height="100%")}_handleFrozenCells(){let e=this._g,i=e.hostElement,t=wijmo_1.Control.getControl(i.querySelector(".wj-flexgrid"));if(t instanceof wijmo_grid_1.FlexGrid&&(t.frozenRows||t.frozenColumns)){wijmo_1.setCss([e._eTL,e._eBL,e._eCHdr,e._eCFtr,e._eRHdr,e._eMarquee],{zIndex:"13"});let t=i.querySelectorAll(".wj-frozen");for(let e=0;e<t.length;e++){let l=t[e];if(wijmo_1.closest(l,".wj-flexgrid")==i){let e=parseInt(l.style.zIndex);l.style.zIndex=(e%10+10).toString()}}}}_toIndex(e){e instanceof wijmo_grid_1.Row&&(e=e.index);return wijmo_1.asNumber(e,!1,!0)}_hdrClick(e){if(!e.defaultPrevented&&0==e.button&&wijmo_1.closestClass(e.target,FlexGridDetailProvider._WJC_DETAIL))switch(this._mode){case DetailVisibilityMode.ExpandMulti:case DetailVisibilityMode.ExpandSingle:let i=this._g,t=i.hitTest(e.target);t.panel||(t=i.hitTest(e));t.panel&&this._toggleRowDetail(t.row)&&e.preventDefault()}}_toggleRowDetail(e){if(e>-1){if(this.isDetailVisible(e)){this.hideDetail(e);return!0}if(this._hasDetail(e)){let i=this._g;i.select(new wijmo_grid_1.CellRange(e,0,e,i.columns.length-1));this.showDetail(e,this._mode==DetailVisibilityMode.ExpandSingle);return!0}}return!1}_selectionChanged(e,i){if(this._mode==DetailVisibilityMode.Selection){this._toSel&&clearTimeout(this._toSel);this._toSel=setTimeout(()=>{e.selection.row>-1?this.showDetail(e.selection.row,!0):this.hideDetail()},300)}}_formatItem(e,i){let t=this._g,l=i.cell,o=i.getRow();if(i.panel==t.cells&&o instanceof DetailRow&&null!=o.detail&&!wijmo_1.hasClass(l,"wj-detail")){wijmo_1.addClass(l,"wj-detail");l.textContent="";l.style.textAlign=l.style.zIndex="";l.className=l.className.replace(/wj\-align\-[\S]+/g,"");l.appendChild(o.detail);null==o.height?this._sizeDetailRow(o):wijmo_1.Control.invalidateAll(o.detail)}if(i.panel==t.rowHeaders&&0==i.col&&this._hasDetail(i.row)){l.style.cursor="";switch(this._mode){case DetailVisibilityMode.ExpandMulti:case DetailVisibilityMode.ExpandSingle:let e=t.rows[i.row+1]instanceof DetailRow,o=e?"minus":"plus",a=FlexGridDetailProvider._WJC_DETAIL;l.innerHTML='<div class="wj-btn wj-btn-glyph '+a+'" role="button" tabindex="-1"><span class="wj-glyph-'+o+'"></span></div>';let s=l.children[0],r=wijmo_1.culture.FlexGridDetailProvider.ariaLabels.toggleDetail;wijmo_1.setAriaLabel(s,r);wijmo_1.setAttribute(s,"aria-expanded",e)}}}_resizedRow(e,i){let t=i.getRow();t instanceof DetailRow&&t.detail&&wijmo_1.Control.refreshAll(t.detail)}_hasDetail(e){let i=this._g.rows[e];return wijmo_1.isFunction(this._rowHasDetailFn)?this._rowHasDetailFn(i):this._isRegularRow(i)}_isRegularRow(e){return!(e instanceof wijmo_grid_1._NewRowTemplate||e instanceof DetailRow)&&!(e instanceof wijmo_grid_1.GroupRow&&!this._g.childItemsPath)}_createDetailCell(e){return this.createDetailCell?this.createDetailCell(e):null}}FlexGridDetailProvider._WJC_DETAIL="wj-elem-detail";exports.FlexGridDetailProvider=FlexGridDetailProvider;wijmo_1._registerModule("wijmo.grid.detail",selfModule);