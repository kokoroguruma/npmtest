/*!
    *
    * Wijmo Library 5.20201.680
    * http://wijmo.com/
    *
    * Copyright(c) GrapeCity, Inc.  All rights reserved.
    *
    * Licensed under the GrapeCity Commercial License.
    * sales@wijmo.com
    * wijmo.com/products/wijmo-5/license/
    *
    */

import{isString,isArray,CollectionView,Aggregate,assert,asEnum,Rect,Color,asBoolean,isFunction,Point,Size,isNumber,asNumber,asString,asArray,_registerModule}from"@grapecity/wijmo";import{FlexPie,_DataPoint,HitTestInfo,SelectionMode,FlexChartBase,DataLabel,_KeyWords,FlexChart,ChartElement,Series,LabelPosition,DataLabelRenderEventArgs,RenderEventArgs,_RectArea,ChartTooltip,_SvgRenderEngine,Legend,Position}from"@grapecity/wijmo.chart";import*as selfModule from"@grapecity/wijmo.chart.hierarchical";export class HierarchicalUtil{static parseDataToHierarchical(t,e,i,s){var r,a=[];if(t instanceof CollectionView&&t.groups.length>0)a=HierarchicalUtil.parseGroupCV(t,e);else if(t.length>0){isString(i)&&i.indexOf(",")>-1&&(i=i.split(","));if(s)a=HierarchicalUtil.parseItems(t,e,i,s);else{r=HierarchicalUtil.convertFlatData(t,e,i);a=HierarchicalUtil.parseItems(r,"value",i,"items")}}return a}static parseGroupCV(t,e){for(var i=[],s=0,r=t.groups.length;s<r;s++){var a=this.parseGroups(t.groups[s],e);i.push(a)}return i}static parseGroups(t,e){var i={};i.name=t.name;i.nameField=t.groupDescription.propertyName;i.item=t.items;if(t.groups&&t.groups.length){i.items=[];for(var s=0,r=t.groups.length;s<r;s++){var a=this.parseGroups(t.groups[s],e);i.items.push(a)}}else t.isBottomLevel&&(i.value=t.getAggregate(Aggregate.Sum,e));return i}static parseItems(t,e,i,s){var r,a=[],l=t.length;for(r=0;r<l;r++)a.push(HierarchicalUtil.parseItem(t[r],e,i,s));return a}static isFlatItem(t,e){return!isArray(t[e])}static convertFlatData(t,e,i){var s,r,a=[],l={},h=t.length;for(s=0;s<h;s++){r=t[s];HierarchicalUtil.convertFlatItem(l,r,e,isArray(i)?i:[i])}HierarchicalUtil.convertFlatToHierarchical(a,l);return a}static convertFlatToHierarchical(t,e){var i=e.flatDataOrder;i&&i.forEach(i=>{var s,r={},a=e[i];r[e.field]=i;if(a.flatDataOrder){s=[];HierarchicalUtil.convertFlatToHierarchical(s,a);r.items=s}else r.value=a;t.push(r)})}static convertFlatItem(t,e,i,s){var r,a,l,h;a=(r=s.slice()).shift();if(null==(l=null==(a=isString(a)?a.trim():a)?i:e[a]))return!1;if(0===r.length){t[l]=e[i]||0;t.flatDataOrder?t.flatDataOrder.push(l):t.flatDataOrder=[l];t.field=a}else{if(null==t[l]){t[l]={};t.flatDataOrder?t.flatDataOrder.push(l):t.flatDataOrder=[l];t.field=a}h=t[l];HierarchicalUtil.convertFlatItem(h,e,i,r)||(t[l]=e[i])}return!0}static parseItem(t,e,i,s){var r,a,l,h,o,n={};if(isArray(s))h=(o=s.slice()).length?o.shift().trim():"";else{o=s;h=s}if(isArray(i)){a=null==(a=(r=i.slice()).shift())?a:a.trim();n.nameField=null==a?e:a;n.name=null==a?t[e]:t[a];l=t[h];0===r.length?n.value=t[e]:l&&isArray(l)&&l.length>0?n.items=HierarchicalUtil.parseItems(l,e,r,o):n.value=t[e]||0}else{n.nameField=null==i?e:i;n.name=null==i?t[e]:t[i];null!=(l=t[h])&&isArray(l)&&l.length>0?n.items=HierarchicalUtil.parseItems(l,e,i,o):n.value=t[e]}n.item=t;return n}static parseFlatItem(t,e,i,s){t.items||(t.items=[])}}export var TreeMapType;!function(t){t[t.Squarified=0]="Squarified";t[t.Horizontal=1]="Horizontal";t[t.Vertical=2]="Vertical"}(TreeMapType||(TreeMapType={}));export class TreeMap extends FlexChartBase{constructor(t,e){super(t,null,!0);this._values=[];this._labels=[];this._areas=[];this._sum=0;this._keywords=new _KeyWords;this._processedData=[];this._depth=1;this._itemIndex=0;this._processedItem=[];this._maxDepth=-1;this._tmItems=[];this._colRowLens=[];this._defPalette=[{titleColor:"#033884",maxColor:"#1450a7",minColor:"#83b3f9"},{titleColor:"#a83100",maxColor:"#dc4a0d",minColor:"#ffb190"},{titleColor:"#006658",maxColor:"#008d7a",minColor:"#7deddf"},{titleColor:"#a10046",maxColor:"#df0061",minColor:"#ff8cbe"},{titleColor:"#784d08",maxColor:"#99681a",minColor:"#efc989"},{titleColor:"#54156f",maxColor:"#722a90",minColor:"#cf95e7"},{titleColor:"#998605",maxColor:"#c2ac19",minColor:"#ffef8b"},{titleColor:"#9a0005",maxColor:"#c80c14",minColor:"#ff888d"}];this.applyTemplate("wj-control wj-flexchart wj-treemap",null,null);this._currentRenderEngine=new _SvgRenderEngine(this.hostElement);this._legend=new Legend(this);this._legend.position=Position.None;this._tooltip=new ChartTooltip;this._tooltip.content="<b>{name}</b><br/>{value}";this._tooltip.showDelay=0;this._lbl=new DataLabel;this._lbl.position=LabelPosition.Center;this._lbl._chart=this;this.hostElement.addEventListener("mousemove",t=>{this.isTouching||this._toogleTooltip(t)});this.hostElement.addEventListener("click",t=>{var e=!0;if(this.maxDepth>0){var i=this.hitTest(t),s=FlexChart._SELECTION_THRESHOLD;this.tooltip&&this.tooltip.threshold&&(s=this.tooltip.threshold);if(i.distance<=s&&i.pointIndex>=-1&&i.pointIndex<this._areas.length){var r=this._areas[i.pointIndex];if(this._currentItem!=r.item){this._currentItem=r.item;this._refreshChart();e=!1}}}e&&this.isTouching&&this._toogleTooltip(t)});this.hostElement.addEventListener("contextmenu",t=>{if(this.maxDepth>0){var e=this.hitTest(t),i=FlexChart._SELECTION_THRESHOLD;this.tooltip&&this.tooltip.threshold&&(i=this.tooltip.threshold);e.distance<=i&&this._rollUp()}t.preventDefault();return!1});this.hostElement.addEventListener("mouseleave",()=>{this._hideToolTip()});this.initialize(e);this.refresh()}_rollUp(){this._currentItem=this._currentItem&&this._currentItem.parent?this._currentItem.parent:null;this._refreshChart()}_toogleTooltip(t){var e=this._tooltip;if(e.content){var i=this.hitTest(t);if(i.distance<=e.threshold){var s=this._getLabelContent(i,this.tooltip.content);this._showToolTip(s,new Rect(t.clientX,t.clientY,5,5))}else this._hideToolTip()}}get selectionMode(){return SelectionMode.None}set selectionMode(t){}get _treeMapItems(){return this._tmItems}get tooltip(){return this._tooltip}get binding(){return this._binding}set binding(t){if(t!=this._binding){this._binding=asString(t,!0);this._bindChart()}}get type(){return null==this._type?TreeMapType.Squarified:this._type}set type(t){if((t=asEnum(t,TreeMapType))!=this._type){this._type=t;this.invalidate()}}get bindingName(){return this._bindingName}set bindingName(t){if(t!=this._bindingName){assert(null==t||isArray(t)||isString(t),"bindingName should be an array or a string.");this._bindingName=t;this._bindChart()}}get dataLabel(){return this._lbl}set dataLabel(t){if(t!=this._lbl){this._lbl=t;this._lbl&&(this._lbl._chart=this)}}get childItemsPath(){return this._childItemsPath}set childItemsPath(t){if(t!=this._childItemsPath){assert(null==t||isArray(t)||isString(t),"childItemsPath should be an array or a string.");this._childItemsPath=t;this._bindChart()}}get maxDepth(){return this._maxDepth}set maxDepth(t){if(t!=this._maxDepth){this._maxDepth=asNumber(t,!0);this.invalidate()}}get palette(){return this._palette}set palette(t){if(t!=this._palette){this._palette=asArray(t);this._tmItems&&this._tmItems.length>0&&this._calculateColorForItems(this._tmItems);this.invalidate()}}_initData(){this._sum=0;this._tmItems=[];this._currentItem=null;this._values=[];this._labels=[];this._processedData=[];this._depth=1;this._processedItem=[]}_performBind(){var t;this._initData();if(this._cv){t=this._cv.items;this._cv.groups&&this._cv.groups.length?this._processedData=HierarchicalUtil.parseDataToHierarchical(this._cv,this.binding,this.bindingName,this.childItemsPath):t&&(this._processedData=HierarchicalUtil.parseDataToHierarchical(t,this.binding,this.bindingName,this.childItemsPath));if(this._processedData&&this._processedData.length){this._sum=this._calculateValueAndDepth(this._processedData,1);this._sortData(this._processedData);this._values=[];this._getTMItemsAndLabelsAndValues(this._processedData,this._tmItems,1,null);this._calculateColorForItems(this._tmItems)}}}_sortData(t){t.forEach(t=>{t.items&&this._sortData(t.items)});t.sort((t,e)=>e.value-t.value)}_getTMItemsAndLabelsAndValues(t,e,i,s,r){t&&t.length>0&&t.forEach((t,r)=>{var a,l=new _TreeMapItem;l.items=[];l.parent=s;l.depth=i;t.items&&this._getTMItemsAndLabelsAndValues(t.items,l.items,i+1,l);a=t.name?t.name:t.value.toString();l.label=a;l.value=t.value;if(null!=s){t.value>s.maxValue&&(s.maxValue=t.value);t.value<s.minValue&&(s.minValue=t.value)}e.push(l);this._labels.push(a);this._values.push(t.value)})}_calculateColorForItems(t,e,i){var s=i;t.forEach((t,i)=>{var r=e;1===t.depth&&(r=this._getColor(i));t.palette=r;var a=t.palette;if(isString(a)){var l=a,h=this._getLightColor(l);t.titleFill=l;t.titleStroke=l;t.fill=h;t.stroke=l}else if(a.maxColor&&a.minColor&&a.titleColor){t.titleFill=a.titleColor;t.titleStroke=a.titleColor;if(null==t.parent){t.fill=a.maxColor;t.stroke=a.maxColor}else{null==s&&(s=new _ColorConverter(a.minColor,t.minValue,a.maxColor,t.maxValue));let e=s._calculateColorByVal(t.value,!0).toString();t.fill=e;t.stroke=e}}if(t.items&&t.items.length>0){var o=new _ColorConverter(a.minColor,t.minValue,a.maxColor,t.maxValue);this._calculateColorForItems(t.items,r,o)}})}_getBindData(t,e,i){var s,r=0;i&&(s=t[i]);r=0;isNumber(s)?r=asNumber(s):s&&(r=parseFloat(s.toString()));if(!isNaN(r)&&isFinite(r))e.push(r);else{r=0;e.push(r)}return r}_calculateValueAndDepth(t,e){var i=0,s=this._values;this._depth<e&&(this._depth=e);t.forEach(t=>{var r;if(t.items){r=this._calculateValueAndDepth(t.items,e+1);t.value=r;s.push(r)}else{r=this._getBindData(t,s,"value");t.value=r}i+=r});return i}_prepareRender(){this._areas=[]}_renderChart(t,e,i){var s,r,a,l=this._rectChart.clone();new Size(l.width,l.height);this.onRendering(new RenderEventArgs(t));var h=e.width,o=e.height;this._tmGroup=t.startGroup(null,null,!0);var n=this._parseMargin(this.plotMargin);this.dataLabel;isNaN(n.left)&&(n.left=TreeMap._MARGIN);isNaN(n.right)&&(n.right=TreeMap._MARGIN);isNaN(n.top)&&(n.top=TreeMap._MARGIN);isNaN(n.bottom)&&(n.bottom=TreeMap._MARGIN);e.top+=n.top;o=e.height-(n.top+n.bottom);e.height=o>0?o:24;e.left+=n.left;h=e.width-(n.left+n.right);e.width=h>0?h:24;this._plotRect=e;s=this._currentItem?[this._currentItem]:this._tmItems;r=null==this._currentItem||this.maxDepth<1?this.maxDepth:this._currentItem&&this._currentItem.items&&this._currentItem.items.length&&this.maxDepth>1?this.maxDepth:this.maxDepth+1;a=this._currentItem?this._currentItem.value:this._sum;this._renderTreeMap(t,e,this._tmGroup,s,a,r);t.endGroup();this.dataLabel.content&&this.dataLabel.position!=LabelPosition.None&&this._renderLabels(t);this.onRendered(new RenderEventArgs(t))}_renderTreeMap(t,e,i,s,r,a){if(r>0){this._itemIndex=0;this._resetItemRects(this._tmItems);this._calculateItemRects(e,s,r,1,a);this._renderHierarchicalTreeMapItems(t,i,e,this._tmItems,r,1,a)}}_resetItemRects(t){t.forEach(t=>{t.rect=new Rect(0,0,0,0);t.isTitle=!1;t.type=this.type;t.items&&t.items.length&&this._resetItemRects(t.items)})}_calculateItemRects(t,e,i,s,r){switch(this.type){case TreeMapType.Horizontal:_TreeMapUtils.horizontal(e,t,i);break;case TreeMapType.Vertical:_TreeMapUtils.vertical(e,t,i);break;case TreeMapType.Squarified:_TreeMapUtils.squarified(e,t,i)}e.forEach((t,e)=>{t.rect.clone();if(t.items&&t.items.length)if(s===r);else if(s>r&&r>=1);else{t.isTitle=!0;this._calculateItemRects(t.itemsRect,t.items,t.value,s+1,r)}})}_renderHierarchicalTreeMapItems(t,e,i,s,r,a,l){var h,o,n,_,c,d=s.length;this.type;if(0!==d)for(var m=0;m<d;m++){h=t.startGroup(TreeMap._CSS_ITEMDEPTH+a);o=s[m];n=Math.abs(o.value);_=o.rect;o.draw(t);c=new _RectArea(_);o.items&&this._renderHierarchicalTreeMapItems(t,h,o.itemsRect,o.items,n,a+1,l);c.tag=this._itemIndex;c.name=o.label;c.value=n;c.item=o;this._areas.push(c);this._itemIndex++;t.endGroup()}}_renderLabels(t){var e,i=this._areas.length,s=this.dataLabel,r=s.position,a=s.connectingLine,l=s.border,h=s.offset||0;t.stroke="null";t.fill="transparent";t.strokeWidth=1;t.startGroup("wj-data-labels");for(var o=0;o<i;o++){var n=this._areas[o];if(n){var _=n.rect,c=new HitTestInfo(this,e);c._setData(null,o);var d=this._getLabelContent(c,s.content);e=new Point(_.left+_.width/2,_.top+_.height/2);if(d&&_.width>0&&_.height>0){var m=new DataLabelRenderEventArgs(t,c,e,d);if(s.onRendering(m)){d=m.text;e=m.point;this._renderLabelAndBorder(t,n,_,d,r,h,e,a,2,l)}}}}t.endGroup()}_renderLabelAndBorder(t,e,i,s,r,a,l,h,o,n){var _,c="wj-data-label",d="wj-data-label-line";switch(r){case LabelPosition.Top:h&&t.drawLine(l.x,l.y,l.x,l.y-a,d);l.y-=o+a;_=this._renderText(t,e,i,s,l,1,2,c);break;case LabelPosition.Bottom:h&&t.drawLine(l.x,l.y,l.x,l.y+a,d);l.y+=o+a;_=this._renderText(t,e,i,s,l,1,0,c);break;case LabelPosition.Left:h&&t.drawLine(l.x,l.y,l.x-a,l.y,d);l.x-=o+a;_=this._renderText(t,e,i,s,l,2,1,c);break;case LabelPosition.Right:h&&t.drawLine(l.x,l.y,l.x+a,l.y,d);l.x+=o+a;_=this._renderText(t,e,i,s,l,0,1,c);break;case LabelPosition.Center:_=this._renderText(t,e,i,s,l,1,1,c)}n&&_&&t.drawRect(_.left-o,_.top-o,_.width+2*o,_.height+2*o,"wj-data-label-border");return _}_renderText(t,e,i,s,r,a,l,h){var o,n=s,_=e.item;o=t.measureString(s,h);if(this.type===TreeMapType.Horizontal&&_.isTitle){o.width>i.height&&(n=this._cutText(s,o.width,i.height));FlexChart._renderRotatedText(t,n,r,a,l,r,-90,h);return null}o.width>i.width&&(n=this._cutText(s,o.width,i.width));return FlexChart._renderText(t,n,r,a,l,h)}_cutText(t,e,i){var s="",r=t.length,a=Math.floor((1-(e-i)/e)*r);t.length>0&&(s=t[0]+(a>1?t.substring(1,a-1)+"..":""));return s}_measureLegendItem(t,e){var i=new Size;i.width=Series._LEGEND_ITEM_WIDTH;i.height=Series._LEGEND_ITEM_HEIGHT;if(e){var s=t.measureString(e,FlexChart._CSS_LABEL,FlexChart._CSS_LEGEND);i.width+=s.width;i.height<s.height&&(i.height=s.height)}i.width+=3*Series._LEGEND_ITEM_MARGIN;i.height+=2*Series._LEGEND_ITEM_MARGIN;return i}_getDesiredLegendSize(t,e,i,s){var r=new Size,a=new Size(i,s),l=this._tmItems.length,h=0,o=0;this._colRowLens=[];for(var n=0;n<l;n++){var _=this._measureLegendItem(t,this._tmItems[n].label);if(e){if(o+_.height>s){r.height=s;this._colRowLens.push(h);h=0;o=0}h<_.width&&(h=_.width);o+=_.height}else{if(h+_.width>i){r.width=i;this._colRowLens.push(o);o=0;h=0}o<_.height&&(o=_.height);h+=_.width}}if(e){r.height<o&&(r.height=o);this._colRowLens.push(h);r.width=this._colRowLens.reduce((t,e)=>t+e,0);r.width>a.width/2&&(r.width=a.width/2)}else{r.width<h&&(r.width=h);this._colRowLens.push(o);r.height=this._colRowLens.reduce((t,e)=>t+e,0);r.height>a.height/2&&(r.height=a.height/2)}return r}_renderLegend(t,e,i,s,r,a){for(var l,h=this._rectLegend,o=this._tmItems.length,n=0,_=e.clone(),c=0;c<o;c++){l=this._tmItems[c].label;var d=this._measureLegendItem(t,l);if(s){if(_.y+d.height>h.top+h.height+1){_.x+=this._colRowLens[n];n++;_.y=e.y}}else if(_.x+d.width>h.left+h.width+1){_.y+=this._colRowLens[n];n++;_.x=e.x}var m=new Rect(_.x,_.y,d.width,d.height);this._drawLegendItem(t,m,c,l);i.push(m);s?_.y+=d.height:_.x+=d.width}}_drawLegendItem(t,e,i,s){t.strokeWidth=1;var r=Series._LEGEND_ITEM_MARGIN,a=this._getColor(i),l=a&&a.maxColor?a.maxColor:a,h=this._getLightColor(l);t.fill=l;t.stroke=h;var o=e.top+.5*e.height,n=Series._LEGEND_ITEM_WIDTH,_=Series._LEGEND_ITEM_HEIGHT;t.drawRect(e.left+r,o-.5*_,n,_,null);s&&FlexChart._renderText(t,s,new Point(e.left+_+2*r,o),0,1,FlexChart._CSS_LABEL)}_getLabelContent(t,e){return isString(e)?this._keywords.replace(e,t):isFunction(e)?e(t):null}hitTest(t,e){var i=this._toControl(t,e),s=new HitTestInfo(this,i),r=null;if(FlexChart._contains(this._rectHeader,i))s._chartElement=ChartElement.Header;else if(FlexChart._contains(this._rectFooter,i))s._chartElement=ChartElement.Footer;else if(FlexChart._contains(this._rectLegend,i)){s._chartElement=ChartElement.Legend;null!==(r=this.legend._hitTest(i))&&r>=0&&r<this._areas.length&&s._setData(null,r)}else if(FlexChart._contains(this._rectChart,i)){for(var a,l=this._areas.length,h=NaN,o=0;o<l;o++){var n=i.clone(),_=this._areas[o];if(_.contains(n)){s._setData(null,_.tag);s._dist=0}var c=_.distance(n);if(void 0!==c&&(isNaN(h)||c<h)){h=c;a=_}}if(0!==s._dist&&null!=a){s._setData(null,a.tag);s._dist=h}s._chartElement=ChartElement.ChartArea}else s._chartElement=ChartElement.None;return s}_getHitTestItem(t){var e=null,i=null;(e=null!=this._cv?this._cv.items:this.itemsSource)&&t<e.length&&(i=e[t]);return i}_getHitTestValue(t){return this._values[t]}_getHitTestLabel(t){return this._labels[t]}}TreeMap._CSS_ITEMDEPTH="wj-treemap-item-depth";TreeMap._MARGIN=0;class _TreeMapItem{constructor(){this.items=[];this.maxValue=Number.MIN_VALUE;this.minValue=Number.MAX_VALUE}draw(t){var e=this.rect;t.strokeWidth=0;if(this.isTitle){t.fill=this.titleFill;t.stroke=this.titleStroke}else{t.fill=this.fill;t.stroke=this.stroke}t.drawRect(e.left,e.top,e.width,e.height,_TreeMapItem._CLASSNAME)}get itemsRect(){var t=this.rect,e=this._rect,i=1===this.depth?2:.5;return this.isTitle?this.type===TreeMapType.Horizontal?new Rect(t.left+t.width+1,t.top,e.width-t.width-2*i,t.height+1):new Rect(t.left,t.top+t.height+1,t.width+1,e.height-t.height-2*i):new Rect(0,0,0,0)}get rect(){var t=this._rect,e=1===this.depth?2:.5,i=t.width,s=t.height,r=t.left,a=t.top;if(this.isTitle){if(this.type===TreeMapType.Horizontal){i=t.width>20?20:i;i=Math.max(20,i-2*e);s=s>2*e?s-2*e:0}else{s=t.height>20?20:s;s=Math.max(20,s-2*e);i=i>2*e?i-2*e:0}r+=e;a+=e}else{i=i>2*e?i-2*e:0;s=s>2*e?s-2*e:0}return new Rect(r,a,i,s)}set rect(t){t!=this._rect&&(this._rect=t)}get isTitle(){return this._isTitle}set isTitle(t){var e=asBoolean(t,!0);e!==this._isTitle&&(this._isTitle=e)}}_TreeMapItem._CLASSNAME="wj-treemap-item";class _ColorConverter{constructor(t,e,i,s,r,a){this.minColor=new Color(t);this.minColorValue=e;this.maxColor=new Color(i);this.maxColorValue=s;this.midColorValue=this.originalMidColorValue=a;this._calculateMidColorValue();this.midColor=this.originalMidColor=new Color(r);this._calculateMidColor()}_resetminColor(t){this.minColor=new Color(t);this._calculateMidColor()}_resetmidColor(t){this.midColor=this.originalMidColor=new Color(t);this._calculateMidColor()}_resetmaxColor(t){this.maxColor=new Color(t);this._calculateMidColor()}_resetminColorValue(t){this.minColorValue=t;this._calculateMidColorValue()}_resetmidColorValue(t){this.midColorValue=this.originalMidColorValue=t;this._calculateMidColorValue()}_resetmaxColorValue(t){this.maxColorValue=t;this._calculateMidColorValue()}_calculateMidColorValue(){null==this.originalMidColorValue&&(this.midColorValue=(this.maxColorValue+this.minColorValue)/2)}_calculateMidColor(){null==this.originalMidColor&&(this.midColor=this._calculateColorByVal(this.midColorValue,!0))}_calculateColorByVal(t,e=!1){var i=this.maxColor,s=this.minColor,r=this.maxColorValue,a=this.minColorValue;if(t>=this.maxColorValue)return new Color(i.toString());if(t<=this.minColorValue)return new Color(s.toString());if(!e){if(t===this.midColorValue)return new Color(this.midColor.toString());if(t<this.midColorValue){i=this.midColor;r=this.midColorValue}else{s=this.midColor;a=this.midColorValue}}return this._getColor(t,i,r,s,a)}_getColor(t,e,i,s,r){return Color.fromRgba(this._getValueByRatio(t,e.r,i,s.r,r),this._getValueByRatio(t,e.g,i,s.g,r),this._getValueByRatio(t,e.b,i,s.b,r),this._getValueByRatio(t,e.a,i,s.a,r))}_getValueByRatio(t,e,i,s,r){return Math.abs(s+Math.round((t-r)*(e-s)/(i-r)))}}class _TreeMapUtils{static squarified(t,e,i){var s=t.slice(),r=e.clone(),a=r.width*r.height/i;do{var l=_TreeMapUtils.getRowedItems(s,r,a);_TreeMapUtils.layoutRowedItems(e,l,r,r.width>r.height)}while(s.length)}static horizontal(t,e,i){var s=e.clone();t.forEach(t=>{var r=[{item:t,val:t.value*e.width*e.height/i}];_TreeMapUtils.layoutRowedItems(e,r,s,!1)})}static vertical(t,e,i){var s=e.clone();t.forEach(t=>{var r=[{item:t,val:t.value*e.width*e.height/i}];_TreeMapUtils.layoutRowedItems(e,r,s,!0)})}static getNarrowLen(t){return Math.min(t.width,t.height)}static getRowedItem(t,e,i){return{item:t,val:i*t.value}}static getRowedItems(t,e,i){var s=t.shift(),r=[],a=[],l=_TreeMapUtils.getNarrowLen(e),h=_TreeMapUtils.getRowedItem(s,e,i);r.push(h);a.push(h);if(t.length>0)do{a.push(_TreeMapUtils.getRowedItem(t[0],e,i));if(!(_TreeMapUtils.worst(r,l)>_TreeMapUtils.worst(a,l)))break;r=a.slice();t.shift()}while(t.length);return r}static layoutRowedItems(t,e,i,s){var r,a=i.left,l=i.top,h=a+i.width,o=l+i.height,n=_TreeMapUtils.sumRowedArray(e);if(s){r=0===i.height?0:n/i.height;a+r>=h&&(r=h-a);e.forEach((t,i)=>{var s=0===r?0:t.val/r;(l+s>o||i===e.length-1)&&(s=o-l);var h=new Rect(a,l,r,s);t.item.rect=h;l+=s});i.left+=r;i.width-=r}else{r=0===i.width?0:n/i.width;l+r>=o&&(r=o-l);e.forEach((t,i)=>{var s=0===r?0:t.val/r;(a+s>h||i===e.length-1)&&(s=h-a);var o=new Rect(a,l,s,r);t.item.rect=o;a+=s});i.top+=r;i.height-=r}}static sumRowedArray(t){for(var e=0,i=t.length,s=0;s<i;s++)e+=t[s].val;return e}static worst(t,e){var i,s,r=_TreeMapUtils.sumRowedArray(t),a=r*r,l=e*e;i=s=t[0].val;t.forEach((t,e)=>{t.val>i?i=t.val:t.val<s&&(s=t.val)});return Math.max(l*i/a,a/(l*s))}}export class Sunburst extends FlexPie{constructor(t,e){super(t,e);this._selectionIndex=0;this.applyTemplate("wj-sunburst",null,null);this.initialize(e);this.refresh()}get bindingName(){return this._bindName}set bindingName(t){if(t!=this._bindName){assert(null==t||isArray(t)||isString(t),"bindingName should be an array or a string.");this._bindName=t;this._bindChart()}}get childItemsPath(){return this._childItemsPath}set childItemsPath(t){if(t!=this._childItemsPath){assert(null==t||isArray(t)||isString(t),"childItemsPath should be an array or a string.");this._childItemsPath=t;this._bindChart()}}_initData(){super._initData();this._processedData=[];this._level=1;this._legendLabels=[];this._processedItem=[];this._values[0]=[]}_performBind(){var t;this._initData();if(this._cv){t=this._cv.items;this._cv.groups&&this._cv.groups.length?this._processedData=HierarchicalUtil.parseDataToHierarchical(this._cv,this.binding,this.bindingName,this.childItemsPath):t&&(this._processedData=HierarchicalUtil.parseDataToHierarchical(t,this.binding,this.bindingName,this.childItemsPath));if(this._processedData&&this._processedData.length){this._sums[0]=this._sum=this._calculateValueAndLevel(this._processedData,1);this._processedData.forEach(t=>{this._legendLabels.push(t.name)})}}}_calculateValueAndLevel(t,e){var i=0,s=this._values[0],r=this._labels;this._level<e&&(this._level=e);t.forEach(t=>{var a;if(t.items){a=this._calculateValueAndLevel(t.items,e+1);t.value=a;s.push(a);r.push(t.name)}else{a=this._getBindData(t,s,r,"value","name");t.value=a}i+=a});return i}_renderPie(t,e,i,s,r,a){var l=this._getCenter();this._sliceIndex=0;this._parentRef={};this._renderHierarchicalSlices(t,l.x,l.y,this._processedData,this._sum,i,s,r,2*Math.PI,a,1)}_renderHierarchicalSlices(t,e,i,s,r,a,l,h,o,n,_){var c,d,m,u,p,g,f,v,C,I,w=s.length,T=h,b=1==this.reversed;m=(a-l)/this._level;c=a-(this._level-_)*m;d=l+(_-1)*m;for(var x=0;x<w;x++){v=e;C=i;f=t.startGroup("wj-slice slice-level"+_);if(1===_){t.fill=this._getColorLight(x);t.stroke=this._getColor(x)}p=s[x];g=Math.abs(p.value);u=Math.abs(g-r)<1e-10?o:o*g/r;I=b?T-.5*u:T+.5*u;if(n>0&&u<o){v+=n*Math.cos(I);C+=n*Math.sin(I)}if(p.items){let e=this._sliceIndex;this._renderHierarchicalSlices(t,v,C,p.items,g,a,l,T,u,0,_+1);for(;e<this._sliceIndex;e++)null==this._parentRef[e]&&(this._parentRef[e]=this._sliceIndex)}this._renderSlice(t,v,C,I,0,this._sliceIndex,c,d,T,u,o);this._processedItem.push(p.item);this._sliceIndex++;b?T-=u:T+=u;t.endGroup();this._pels.push(f)}}_getLabelsForLegend(){return this._legendLabels||[]}_highlightCurrent(){this.selectionMode!=SelectionMode.None&&this._highlight(!0,this._selectionIndex)}hitTest(t,e){var i=super.hitTest(t,e),s=this._toControl(t,e);if(FlexChartBase._contains(this._rectChart,s)){var r=i.pointIndex,a=this._processedItem[r],l=new _DataPoint(null,r,null,null);l.item=a;i._setDataPoint(l)}return i}_getSelectedItemOffset(t,e){var i=0,s=0,r=0;if(this.selectedItemOffset>0)if(t==this.selectedIndex)r=this.selectedItemOffset;else{let i=this._getSelectedParentIndex(t);if(null!=i){let t=this._areas[i];this.dataLabel.position;r=this.selectedItemOffset;e=((e=t.langle+this._rotationAngles[0])%360+360)%360;e*=Math.PI/180}}if(r>0){i=Math.cos(e)*r*this._radius;s=Math.sin(e)*r*this._radius}return{x:i,y:s}}_getSelectedParentIndex(t){let e=this._parentRef[t];return null!=e?e===this.selectedIndex?e:this._getSelectedParentIndex(e):null}}_registerModule("wijmo.chart.hierarchical",selfModule);